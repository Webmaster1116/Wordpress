<?php
 namespace MailPoetVendor\Symfony\Component\DependencyInjection\Compiler; if (!defined('ABSPATH')) exit; use MailPoetVendor\Symfony\Component\DependencyInjection\Alias; use MailPoetVendor\Symfony\Component\DependencyInjection\Argument\ServiceClosureArgument; use MailPoetVendor\Symfony\Component\DependencyInjection\Argument\ServiceLocatorArgument; use MailPoetVendor\Symfony\Component\DependencyInjection\ContainerBuilder; use MailPoetVendor\Symfony\Component\DependencyInjection\Definition; use MailPoetVendor\Symfony\Component\DependencyInjection\Exception\InvalidArgumentException; use MailPoetVendor\Symfony\Component\DependencyInjection\Reference; use MailPoetVendor\Symfony\Component\DependencyInjection\ServiceLocator; final class ServiceLocatorTagPass extends \MailPoetVendor\Symfony\Component\DependencyInjection\Compiler\AbstractRecursivePass { use PriorityTaggedServiceTrait; protected function processValue($value, $isRoot = \false) { if ($value instanceof \MailPoetVendor\Symfony\Component\DependencyInjection\Argument\ServiceLocatorArgument) { if ($value->getTaggedIteratorArgument()) { $value->setValues($this->findAndSortTaggedServices($value->getTaggedIteratorArgument(), $this->container)); } return self::register($this->container, $value->getValues()); } if (!$value instanceof \MailPoetVendor\Symfony\Component\DependencyInjection\Definition || !$value->hasTag('container.service_locator')) { return parent::processValue($value, $isRoot); } if (!$value->getClass()) { $value->setClass(\MailPoetVendor\Symfony\Component\DependencyInjection\ServiceLocator::class); } $arguments = $value->getArguments(); if (!isset($arguments[0]) || !\is_array($arguments[0])) { throw new \MailPoetVendor\Symfony\Component\DependencyInjection\Exception\InvalidArgumentException(\sprintf('Invalid definition for service "%s": an array of references is expected as first argument when the "container.service_locator" tag is set.', $this->currentId)); } $i = 0; foreach ($arguments[0] as $k => $v) { if ($v instanceof \MailPoetVendor\Symfony\Component\DependencyInjection\Argument\ServiceClosureArgument) { continue; } if (!$v instanceof \MailPoetVendor\Symfony\Component\DependencyInjection\Reference) { throw new \MailPoetVendor\Symfony\Component\DependencyInjection\Exception\InvalidArgumentException(\sprintf('Invalid definition for service "%s": an array of references is expected as first argument when the "container.service_locator" tag is set, "%s" found for key "%s".', $this->currentId, \is_object($v) ? \get_class($v) : \gettype($v), $k)); } if ($i === $k) { unset($arguments[0][$k]); $k = (string) $v; ++$i; } elseif (\is_int($k)) { $i = null; } $arguments[0][$k] = new \MailPoetVendor\Symfony\Component\DependencyInjection\Argument\ServiceClosureArgument($v); } \ksort($arguments[0]); $value->setArguments($arguments); $id = '.service_locator.' . \MailPoetVendor\Symfony\Component\DependencyInjection\ContainerBuilder::hash($value); if ($isRoot) { if ($id !== $this->currentId) { $this->container->setAlias($id, new \MailPoetVendor\Symfony\Component\DependencyInjection\Alias($this->currentId, \false)); } return $value; } $this->container->setDefinition($id, $value->setPublic(\false)); return new \MailPoetVendor\Symfony\Component\DependencyInjection\Reference($id); } public static function register(\MailPoetVendor\Symfony\Component\DependencyInjection\ContainerBuilder $container, array $refMap, string $callerId = null) : \MailPoetVendor\Symfony\Component\DependencyInjection\Reference { foreach ($refMap as $id => $ref) { if (!$ref instanceof \MailPoetVendor\Symfony\Component\DependencyInjection\Reference) { throw new \MailPoetVendor\Symfony\Component\DependencyInjection\Exception\InvalidArgumentException(\sprintf('Invalid service locator definition: only services can be referenced, "%s" found for key "%s". Inject parameter values using constructors instead.', \is_object($ref) ? \get_class($ref) : \gettype($ref), $id)); } $refMap[$id] = new \MailPoetVendor\Symfony\Component\DependencyInjection\Argument\ServiceClosureArgument($ref); } \ksort($refMap); $locator = (new \MailPoetVendor\Symfony\Component\DependencyInjection\Definition(\MailPoetVendor\Symfony\Component\DependencyInjection\ServiceLocator::class))->addArgument($refMap)->setPublic(\false)->addTag('container.service_locator'); if (null !== $callerId && $container->hasDefinition($callerId)) { $locator->setBindings($container->getDefinition($callerId)->getBindings()); } if (!$container->hasDefinition($id = '.service_locator.' . \MailPoetVendor\Symfony\Component\DependencyInjection\ContainerBuilder::hash($locator))) { $container->setDefinition($id, $locator); } if (null !== $callerId) { $locatorId = $id; $container->register($id .= '.' . $callerId, \MailPoetVendor\Symfony\Component\DependencyInjection\ServiceLocator::class)->setPublic(\false)->setFactory([new \MailPoetVendor\Symfony\Component\DependencyInjection\Reference($locatorId), 'withContext'])->addTag('container.service_locator_context', ['id' => $callerId])->addArgument($callerId)->addArgument(new \MailPoetVendor\Symfony\Component\DependencyInjection\Reference('service_container')); } return new \MailPoetVendor\Symfony\Component\DependencyInjection\Reference($id); } } 